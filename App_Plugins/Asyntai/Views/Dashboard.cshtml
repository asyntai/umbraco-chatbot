@model Asyntai.Umbraco.Chatbot.Models.AsyntaiSettings
@{
    Layout = null;
    var connected = !string.IsNullOrWhiteSpace(Model?.SiteId);
    var accountEmail = Model?.AccountEmail ?? string.Empty;
    var expectedOrigin = "https://asyntai.com";
    var connectUrl = expectedOrigin + "/wp-auth?platform=umbraco";
}
<!DOCTYPE html>
<html>
<head>
    <title>Asyntai AI Chatbot</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .asyntai-wrap { max-width: 960px; margin: 0 auto; }
        h1 { color: #1b264f; margin-bottom: 20px; }
        .status { margin-bottom: 20px; font-size: 14px; }
        .status-connected { color: #008a20; font-weight: 600; }
        .status-disconnected { color: #a00; font-weight: 600; }
        .btn { display: inline-block; padding: 10px 20px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; text-decoration: none; }
        .btn-primary { background: #2563eb; color: #fff; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-secondary { background: #e5e7eb; color: #374151; margin-left: 8px; padding: 6px 12px; }
        .btn-secondary:hover { background: #d1d5db; }
        .card { max-width: 820px; margin: 20px 0; padding: 32px; border: 1px solid #ddd; border-radius: 8px; background: #fff; text-align: center; }
        .card-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; color: #1b264f; }
        .card-text { font-size: 16px; margin-bottom: 16px; color: #666; }
        .tip { margin-top: 16px; font-size: 14px; color: #666; }
        .tip a { color: #3182ce; text-decoration: underline; }
        .fallback { margin-top: 12px; color: #666; font-size: 14px; }
        .fallback a { color: #3182ce; text-decoration: underline; }
        .alert { padding: 12px 16px; margin-bottom: 16px; border-radius: 4px; font-size: 14px; display: none; }
        .alert-success { background-color: #d4edda; border-left: 4px solid #00a32a; color: #155724; }
        .alert-error { background-color: #f8d7da; border-left: 4px solid #d63638; color: #721c24; }
    </style>
</head>
<body>
    <div class="asyntai-wrap">
        <h1>Asyntai AI Chatbot</h1>

        <p id="asyntai-status" class="status">
            Status: <span class="@(connected ? "status-connected" : "status-disconnected")">@(connected ? "Connected" : "Not connected")</span>@if (connected && !string.IsNullOrEmpty(accountEmail)) { <text> as @accountEmail</text> }
            @if (connected)
            {
                <button id="asyntai-reset" class="btn btn-secondary">Reset</button>
            }
        </p>

        <div id="asyntai-alert" class="alert"></div>

        <div id="asyntai-connected-box" style="display: @(connected ? "block" : "none");">
            <div class="card">
                <div class="card-title">Asyntai is now enabled</div>
                <div class="card-text">Set up your AI chatbot, review chat logs and more:</div>
                <a class="btn btn-primary" href="https://asyntai.com/dashboard" target="_blank" rel="noopener">Open Asyntai Panel</a>
                <div class="tip">
                    <strong>Tip:</strong> If you want to change how the AI answers, please <a href="https://asyntai.com/dashboard#setup" target="_blank" rel="noopener">go here</a>.
                </div>
            </div>
        </div>

        <div id="asyntai-popup-wrap" style="display: @(connected ? "none" : "block");">
            <div class="card">
                <div class="card-text">Create a free Asyntai account or sign in to enable the chatbot</div>
                <button id="asyntai-connect-btn" class="btn btn-primary">Get started</button>
                <div class="fallback">If it doesn't work, <a href="@connectUrl" target="_blank" rel="noopener">open the connect window</a>.</div>
            </div>
        </div>
    </div>

    <script>
    (function(){
        var expectedOrigin = '@Html.Raw(expectedOrigin)';
        var connectUrl = '@Html.Raw(connectUrl)';

        function showAlert(msg, ok) {
            var el = document.getElementById('asyntai-alert');
            if (!el) return;
            el.style.display = 'block';
            el.className = 'alert ' + (ok ? 'alert-success' : 'alert-error');
            el.textContent = msg;
        }

        function openPopup() {
            var state = 'umbraco_' + Math.random().toString(36).substr(2, 9);
            var url = connectUrl + (connectUrl.indexOf('?') > -1 ? '&' : '?') + 'state=' + encodeURIComponent(state);
            var w = 800, h = 720;
            var y = window.top.outerHeight / 2 + window.top.screenY - (h / 2);
            var x = window.top.outerWidth / 2 + window.top.screenX - (w / 2);
            var pop = window.open(url, 'asyntai_connect', 'toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=' + w + ',height=' + h + ',top=' + y + ',left=' + x);
            if (!pop) { showAlert('Popup blocked. Please allow popups or use the link below.', false); return; }
            pollForConnection(state);
        }

        function pollForConnection(state) {
            var attempts = 0;
            function check() {
                if (attempts++ > 60) return;
                var script = document.createElement('script');
                var cb = 'asyntai_cb_' + Date.now();
                script.src = expectedOrigin + '/connect-status.js?state=' + encodeURIComponent(state) + '&cb=' + cb;
                window[cb] = function(data) {
                    try { delete window[cb]; } catch (e) {}
                    if (data && data.site_id) { saveConnection(data); return; }
                    setTimeout(check, 500);
                };
                script.onerror = function() { setTimeout(check, 1000); };
                document.head.appendChild(script);
            }
            setTimeout(check, 800);
        }

        function saveConnection(data) {
            showAlert('Asyntai connected. Saving...', true);
            var payload = { siteId: data.site_id || '' };
            if (data.script_url) payload.scriptUrl = data.script_url;
            if (data.account_email) payload.accountEmail = data.account_email;
            fetch('/umbraco/asyntai/api/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                credentials: 'same-origin',
                body: JSON.stringify(payload)
            }).then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
            .then(function(json) {
                if (!json || !json.success) throw new Error((json && json.error) || 'Save failed');
                showAlert('Asyntai connected. Chatbot enabled on all pages.', true);
                var status = document.getElementById('asyntai-status');
                if (status) {
                    var html = 'Status: <span class="status-connected">Connected</span>';
                    if (payload.accountEmail) { html += ' as ' + payload.accountEmail; }
                    html += ' <button id="asyntai-reset" class="btn btn-secondary">Reset</button>';
                    status.innerHTML = html;
                }
                var box = document.getElementById('asyntai-connected-box'); if (box) box.style.display = 'block';
                var wrap = document.getElementById('asyntai-popup-wrap'); if (wrap) wrap.style.display = 'none';
            }).catch(function(err) { showAlert('Could not save settings: ' + (err && err.message || err), false); });
        }

        function resetConnection() {
            if (!confirm('Are you sure you want to reset the Asyntai connection?')) return;
            fetch('/umbraco/asyntai/api/reset', {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                credentials: 'same-origin'
            }).then(function(r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
            .then(function() { window.location.reload(); })
            .catch(function(err) { showAlert('Reset failed: ' + (err && err.message || err), false); });
        }

        document.addEventListener('click', function(ev) {
            var t = ev.target;
            if (t && t.id === 'asyntai-connect-btn') { ev.preventDefault(); openPopup(); }
            if (t && t.id === 'asyntai-reset') { ev.preventDefault(); resetConnection(); }
        });
    })();
    </script>
</body>
</html>
